[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_extrude: 1.0
gcode:
  {% if printer.print_stats.filename != "" %}
    SAVE_GCODE_STATE NAME=PAUSE_state
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    M83                 ; extruder relative mode
    G92 E0              ; zero the extruder
    G1 E-{E} F3600      ; retract filament
    G92 E0              ; zero the extruder
    _SAFE_PARK
    PAUSE_BASE
  {% endif %}
[gcode_macro RESUME]
rename_existing: RESUME_BASE
gcode:
  {% if printer.print_stats.filename != "" %}
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}

    M83                 ; extruder relative mode
    G92 E0              ; zero the extruder
    G1 E{E} F3600        ; retract filament
    G92 E0              ; zero the extruder

    RESUME_BASE
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
  {% endif %}

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
  {% if printer.print_stats.filename != "" %}
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}

    M83                 ; extruder relative mode
    G92 E0              ; zero the extruder
    G1 E-{E} F3600      ; retract filament
    G92 E0              ; zero the extruder

    _SAFE_PARK
    CLEAR_PAUSE
    TURN_OFF_HEATERS
    SDCARD_RESET_FILE
    CANCEL_PRINT_BASE
  {% endif %}

[gcode_macro _SAFE_PARK]
gcode:
  SAVE_GCODE_STATE NAME=PARK_STATE
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 5.0) %}
    {% set Z = 5.0 %}
  {% else %}
    {% set Z = max_z - act_z %}
  {% endif %}

  G91                        ; relative for safe Z lift
  G1 Z{Z}                    ; safe lifting
  G90                        ; absolute for parking

  _PARK_{printer.toolhead.extruder}
  RESTORE_GCODE_STATE NAME=PARK_STATE